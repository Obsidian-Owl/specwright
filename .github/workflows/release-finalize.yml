name: Release Finalize

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  tag-and-release:
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'release/v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Extract version
        id: version
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"
          VERSION="${BRANCH#release/v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Extract release notes from CHANGELOG
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Extract the section between ## [VERSION] and the next ## [
          sed -n "/^## \[${VERSION}\]/,/^## \[/{/^## \[/d;p}" CHANGELOG.md > /tmp/release_notes.md

      - name: Create tag and release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${VERSION}" -m "v${VERSION}"
          git push origin "v${VERSION}"

          gh release create "v${VERSION}" \
            --title "v${VERSION}" \
            --notes-file /tmp/release_notes.md

      - name: Cleanup release branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"
          git push origin --delete "$BRANCH" 2>/dev/null || true
